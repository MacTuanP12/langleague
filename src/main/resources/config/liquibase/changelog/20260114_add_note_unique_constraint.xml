<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
        Add unique constraint to ensure 1 student can only have 1 note per unit.
        Business rule: 1 unit = 1 note per student
        Student must DELETE old note before creating new one.
    -->
    <changeSet id="20260114-note-unique-constraint" author="langleague">
        <!-- Clean up any duplicate data first (keep only the most recent note per user+unit) -->
        <sql>
            DELETE FROM note 
            WHERE id NOT IN (
                SELECT id FROM (
                    SELECT MAX(id) as id
                    FROM note 
                    GROUP BY user_profile_id, unit_id
                ) as keeper
            )
        </sql>
        
        <!-- Add unique constraint -->
        <addUniqueConstraint 
            tableName="note"
            columnNames="user_profile_id, unit_id"
            constraintName="uk_note_user_unit"/>
    </changeSet>

</databaseChangeLog>
